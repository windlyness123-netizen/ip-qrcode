<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPå½’å±åœ°æŸ¥è¯¢</title>
    <style>
        /* ... æ ·å¼ä¸ä¸Šä¸€ç‰ˆæœ¬å®Œå…¨ä¸€è‡´ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç¯‡å¹… ... */
        /* è¯·ç›´æ¥ä½¿ç”¨ä¸Šä¸€è½®å›å¤ä¸­æä¾›çš„å®Œæ•´æ ·å¼ä»£ç  */
        body { ... }
        .container { ... }
        .title { ... }
        .ip-address { ... }
        .location { ... }
        .nj { ... }
        .not-nj { ... }
        .detail { ... }
        .loading { ... }
        .footer { ... }
        .error-detail { ... }
        .contact-info { ... }
        .contact-info a { ... }
        .contact-info .phone { ... }
        .input-area { ... }
        #ipInput { ... }
        #ipInput:focus { ... }
        #queryBtn { ... }
        #queryBtn:hover { ... }
        #queryBtn:disabled { ... }
        .note { ... }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">ğŸ“ IPå½’å±åœ°æŸ¥è¯¢</div>

        <div class="input-area">
            <input type="text" id="ipInput" placeholder="è¾“å…¥IPåœ°å€ï¼ˆå¦‚ 8.8.8.8ï¼‰" value="">
            <button id="queryBtn" onclick="handleManualQuery()">æŸ¥è¯¢</button>
        </div>
        <div class="note">æç¤ºï¼šè¾“å…¥IPåç‚¹å‡»æŸ¥è¯¢ï¼Œå°†æ˜¾ç¤ºè¯¥IPçš„å½’å±åœ°ã€‚é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ˜¾ç¤ºå½“å‰è®¾å¤‡IPã€‚</div>

        <div id="ipDisplay" class="loading">æ­£åœ¨è·å–IPä¿¡æ¯...</div>
        <div id="errorDetail" class="error-detail"></div>

        <div class="contact-info">
            <div style="font-size: 18px; margin-bottom: 8px;">ğŸ“¸ åŠŸèƒ½æ­£å¸¸äº†ï¼Ÿæˆªå›¾æœ¬é¡µé¢è”ç³»åœ¨çº¿å®¢æœ</div>
            <div>æ²¡å›å¤è¯·è‡´ç”µ <span class="phone">18761662888</span></div>
        </div>
    </div>
    <div class="footer">æ‰«ç å³æŸ¥ Â· å®æ—¶æ›´æ–°</div>

    <script>
        function showError(msg) {
            document.getElementById('errorDetail').innerText = 'é”™è¯¯ï¼š' + msg;
        }

        // æ–°å¢ç™¾åº¦æŸ¥è¯¢å‡½æ•°
        async function queryBaiduIP(ip) {
            try {
                const url = `https://qifu.baidu.com/api/v1/ip-portrait/brief-info?ip=${ip}`;
                // æ³¨æ„ï¼šè¿™ä¸ªæ¥å£å¯èƒ½éœ€è¦ç‰¹å®šçš„è¯·æ±‚å¤´æ‰èƒ½è®¿é—®ï¼Œè¿™é‡Œå…ˆå°è¯•æœ€ç®€å•çš„fetch
                // å¦‚æœé‡åˆ°403é”™è¯¯ï¼Œå¯èƒ½éœ€è¦åƒä½ æŠ“åŒ…é‚£æ ·æ·»åŠ Refererå’ŒCookieç­‰å¤´ä¿¡æ¯
                const res = await fetch(url, {
                    timeout: 5000,
                    headers: {
                        // å°è¯•æ·»åŠ å¿…è¦çš„è¯·æ±‚å¤´ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
                        'Referer': 'https://qifu.baidu.com/',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.6261.95 Safari/537.36'
                        // æ³¨æ„ï¼šä¸å»ºè®®ç¡¬ç¼–ç Cookieï¼Œå› ä¸ºä¼šè¿‡æœŸã€‚å¦‚æœä¸æ·»åŠ è¿™äº›å¤´ä¹Ÿèƒ½æˆåŠŸï¼Œé‚£æ˜¯æœ€å¥½çš„ã€‚
                    }
                });
                if (!res.ok) {
                    console.warn(`ç™¾åº¦APIè¿”å›çŠ¶æ€ç : ${res.status}`);
                    return null; // è¿”å›nullè¡¨ç¤ºå¤±è´¥ï¼Œä»¥ä¾¿å°è¯•å¤‡ç”¨API
                }
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    // æˆåŠŸæå–æ•°æ®
                    return {
                        city: data.data.city || '',
                        region: data.data.province || '',
                        country: data.data.country || ''
                    };
                } else {
                    console.warn('ç™¾åº¦APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', data);
                    return null;
                }
            } catch (e) {
                console.warn('ç™¾åº¦APIè¯·æ±‚å¤±è´¥:', e);
                return null;
            }
        }

        // ä¿®æ”¹åçš„é€šç”¨IPæŸ¥è¯¢å‡½æ•°
        async function queryIP(ip) {
            document.getElementById('ipDisplay').innerHTML = '<div class="loading">æ­£åœ¨æŸ¥è¯¢...</div>';
            document.getElementById('errorDetail').innerText = '';

            let location = 'æœªçŸ¥';
            let city = '', region = '', country = '';

            // 1. ä¼˜å…ˆä½¿ç”¨ç™¾åº¦API
            const baiduResult = await queryBaiduIP(ip);
            if (baiduResult) {
                city = baiduResult.city;
                region = baiduResult.region;
                country = baiduResult.country;
                location = (region + ' ' + city).trim() || country;
            } else {
                // 2. å¦‚æœç™¾åº¦APIå¤±è´¥ï¼Œå†å°è¯•åŸæ¥çš„å¤‡ç”¨API
                console.log('ç™¾åº¦APIå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨API...');
                const geoAPIs = [
                    { url: (ip) => `https://ipapi.co/${ip}/json/`, format: 'ipapi' },
                    { url: (ip) => `https://ip.sb/geoip/${ip}`, format: 'ip.sb' },
                    { url: (ip) => `https://ipwho.is/${ip}`, format: 'ipwhois' }
                ];

                function extractLocation(data, format) {
                    if (format === 'ipapi') {
                        return {
                            city: data.city || '',
                            region: data.region || '',
                            country: data.country_name || ''
                        };
                    } else if (format === 'ip.sb') {
                        return {
                            city: data.city || '',
                            region: data.region || '',
                            country: data.country || ''
                        };
                    } else if (format === 'ipwhois') {
                        return {
                            city: data.city || '',
                            region: data.region || '',
                            country: data.country || ''
                        };
                    }
                    return { city: '', region: '', country: '' };
                }

                for (let geo of geoAPIs) {
                    try {
                        const url = geo.url(ip);
                        const res = await fetch(url, { timeout: 5000 });
                        if (!res.ok) continue;
                        const data = await res.json();
                        const extracted = extractLocation(data, geo.format);
                        if (extracted.country || extracted.city) {
                            city = extracted.city;
                            region = extracted.region;
                            country = extracted.country;
                            location = (region + ' ' + city).trim() || country;
                            break;
                        }
                    } catch (e) {
                        console.warn('å¤‡ç”¨Geo APIå¤±è´¥:', geo.format, e);
                    }
                }
            }

            // åˆ¤æ–­æ˜¯å¦åŒ…å«â€œå—äº¬â€
            const isNanjing = location.includes('å—äº¬');

            document.getElementById('ipDisplay').innerHTML = `
                <div class="ip-address">${ip}</div>
                <div class="location ${isNanjing ? 'nj' : 'not-nj'}">
                    ${location}
                </div>
                <div class="detail">
                    ${isNanjing ? 'âœ… å—äº¬IP' : 'âŒ éå—äº¬IP'}
                </div>
            `;
        }

        // è·å–å½“å‰è®¾å¤‡IPï¼ˆä¸ä¹‹å‰ç›¸åŒï¼Œä½†å¢åŠ äº†ç™¾åº¦APIçš„ä¼˜å…ˆçº§ï¼‰
        async function getCurrentIP() {
            const ipAPIs = [
                'https://api.ipify.org?format=json',
                'https://api.my-ip.io/ip.json',
                'https://ipapi.co/json/'
            ];

            let ip = null;
            for (let api of ipAPIs) {
                try {
                    const res = await fetch(api, { timeout: 5000 });
                    if (!res.ok) continue;
                    const data = await res.json();
                    ip = data.ip || data.ip_address;
                    if (ip) break;
                } catch (e) {
                    console.warn('IP API å¤±è´¥:', api, e);
                }
            }

            if (!ip) {
                document.getElementById('ipDisplay').innerHTML = '<div class="ip-address">è·å–å¤±è´¥</div><div class="detail">æ— æ³•è·å–IPåœ°å€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
                showError('æ‰€æœ‰IP APIå‡å¤±è´¥');
                return;
            }

            await queryIP(ip);
        }

        // å¤„ç†æ‰‹åŠ¨æŸ¥è¯¢
        async function handleManualQuery() {
            const input = document.getElementById('ipInput').value.trim();
            if (!input) {
                showError('è¯·è¾“å…¥IPåœ°å€');
                return;
            }
            const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipPattern.test(input)) {
                showError('IPåœ°å€æ ¼å¼ä¸æ­£ç¡®');
                return;
            }
            await queryIP(input);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–å½“å‰IP
        getCurrentIP().catch(e => {
            document.getElementById('ipDisplay').innerHTML = '<div class="ip-address">è·å–å¤±è´¥</div><div class="detail">è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•</div>';
            showError(e.message);
        });
    </script>
</body>
</html>
